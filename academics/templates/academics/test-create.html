{% extends "base.html" %}
{% block content %}
<div class="test-create-container">
  <div class="question-papers-get">
    <div class="container">
      {% csrf_token %}
      <!-- <p><label for="get_grade">Grade:</label> <select name="grade" onchange=getgradename(this) required="" id="get_grade">
        <option value="" selected="">---------</option>
      </select></p> -->
      {{form.as_p}}
      <label for=""> Subject: </label>
      <select name="subject" required="" onchange=getsubjectname(this) id="id_subject_2">
        <option value="" selected="">---------</option>
      </select>
      <!-- 
      <p class="row"><label class="col-3" for="id_grade">Grade:</label><input class="col-7 form-control" type="text"
          name="grade" maxlength="14" required="" id="id_grade"></p>
      <p class="row"><label class="col-3" for="id_subject">Subject:</label><input type="text" class="col-7 form-control"
          name="subject" maxlength="20" required="" id="id_subject"></p> -->

      <!-- <p class="text-center"> <button id="get-question-papers" onclick=get()>Get</button> </p> -->
    </div>
  </div>
  <div class="header">
    <h2 class="text-center">Grade - <span id="grade-head"></span></h2>
    <hr>
    <h3 class="text-center">Subject - <span id="subject-head"></span></h3>
  </div>
  <div class="question-papers-card"></div>
  <div class="messages container-fluid">

  </div>
  <div class="error-messages container-fluid">

  </div>

  <!-- Modal -->

  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content test-model ">
        <div class="modal-header">
          <h4 class="modal-title" id="exampleModalLabel">Create Test</h4>
          <button type="button" class="close" id="close-btn" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body modal-body-1">
          {% csrf_token %}
          {{ test_form.as_p }}

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <span class="create-btn-container"> <button type="button" id="test-create-btn"
              class="btn btn-primary">Create</button></span>

        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editquestion-paper" tabindex="-1" role="dialog" aria-labelledby="editquestion-paperLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content test-model ">
        <div class="modal-header">
          <h4 class="modal-title" id="exampleModalLabel">Question Paper</h4>
          <button type="button" class="close" id="close-btn" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body modal-body-2">
          {% csrf_token %}
          <p><label for="id_timing">Timing:</label> <input type="number" name="timing"
              placeholder="duration in seconds" min="0" required="" id="id_timing"></p>
          <p><label for="id_overallmarks">Overallmarks:</label> <input type="number" name="overallmarks" min="0"
              required="" id="id_overallmarks"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <span class="question-edit-btn-container"> </span>

        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

  <!-- <script src="js/bootstrap.js"></script> -->
</div>
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script>
  var userId = localStorage.getItem('id')
  var grade_name;
  var token = localStorage.getItem('token')
  let head = document.querySelector('.header')
  head.style.display = 'none'
  let modal_body = document.querySelector('.modal-body-1')
  url = 'https://schooltestproject.herokuapp.com/api/question-paper-list/'

  let error = true
  let set_id = false
  let subject_name
  var user_id = localStorage.getItem('id')
  var user_type = localStorage.getItem('user_type')
  let messages = document.querySelector('.messages')
  let error_messages = document.querySelector('.error-messages')
  let container = document.querySelector('.question-papers-card')
  document.getElementById('nav-questionpaperlist').style.opacity = '0.5';
  $(document).ready(function(){ 
    var user = localStorage.getItem('user_type')
    if (user != 'is_admin'){
     return window.location.href = '/404'; 
    }
    else{

  function get() {
    var grade = document.getElementById('get_grade').value
    var subject = document.getElementById('id_subject_2').value
    url2 = new URL('https://schooltestproject.herokuapp.com/api/question-paper-list/');
    url2.searchParams.append('grade', grade_name);
    url2.searchParams.append('subject', subject_name)
    console.log(grade, subject)
  if(!grade || !subject_name){
      container.innerHTML = `Subject is not selected`;
      return
    }
    fetch(url2, {
      method: 'GET',
      headers: {
        'content-Type': 'application/json',
        'Authorization': 'token' + ' ' + token,
        // 'X-CSRFToken': csrftoken
      }
    }).then(res => res.json()).then(data => {
      console.log(data)
      let content = '';
      if (data.status == 'success') {
        data.data.forEach((d, index) => {

          error = false
          if (!set_id) {
            grade_id = d.grade
            subject_id = d.subject
            console.log(subject_id, grade_id)
            set_id = true
          }
          let new_date = new Date(d.created_at)
          console.log(new_date)
          content = content + `<div class="questions-paper-card" id='${d.id}'>


<p >created_by : <span class="created_by">${d.created_by}</span></p>

<p >created_at : <span class="created_at">${(new_date.toDateString())}</span></p>

<p> No of questions : ${(d.no_of_questions).length} </p>`

          if (d.test_id) {
            content += `Test ID : ${d.test_id}
            
            <button onclick=edit_question_paper(${d.id},${d.timing},${d.overall_marks}) class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editquestion-paper">Edit</button>
            `
          } else {
            content += `<button type="button" onclick=test_create(${d.id}) class="btn btn-primary btn-sm" data-toggle="modal" data-target="#exampleModal">
  Create-Test
</button> <button onclick=edit_question_paper(${d.id},${d.timing},${d.overall_marks}) class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editquestion-paper">Edit</button>`
          }
          content += `</div>`

        })
        container.innerHTML = content;

      }
      else {
        error_messages.innerHTML = 'invalid input'
      }
      if (error) {
        error_messages.innerHTML = 'invalid input'
      } else {
        document.getElementById('grade-head').textContent = `${grade_name}`
        document.getElementById('subject-head').textContent = `${subject_name}`
        head.style.display = 'block'
      }
    })
  }


  document.getElementById('get_grade').addEventListener('change',()=>{
    
    let e = document.getElementById('get_grade')
    grade_name = e.options[e.selectedIndex].text;
   
    console.log(grade_name)

  })

  $("#get_grade").change(function () {
    var url_for_change = 'https://schooltestproject.herokuapp.com/api/ajax/load-subject/';
    var gradeId = $(this).val();

    $.ajax({
      url: url_for_change,
      data: {
        'grade': gradeId
      },
      success: function (data) {
        $("#id_subject_2").html(data);
      }
    });

  });



  


  function test_create(id) {
    let create_btn_container = document.querySelector('.create-btn-container')
    modal_body.innerHTML = `          {% csrf_token %}
          {{ test_form.as_p }}`
    create_btn_container.innerHTML = `<button type="button" id="test-create-btn" onclick=create(${id}) class="btn btn-primary ">Create</button>`
    document.getElementById('test-create-btn').style.display = 'block'
  }




  // user_id, user_type = get_user_id();
  function create(question_id) {
    var grade = document.getElementById('id_grade').value
    let csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    // let form_duration = document.getElementById('id_duration').value
    //   let form_marks = document.getElementById('id_marks').value
    let form_remarks = document.getElementById('id_remarks').value
    let form_description = document.getElementById('id_description').value
    let form_percentage = document.getElementById('id_pass_percentage').value
    let marks = 0;
    let duration = 0;
    document.getElementById('nav-questionpaperlist').style.opacity = '0.5';
    url2 = new URL(`https://schooltestproject.herokuapp.com/api/test-questions/`);
    url2.searchParams.append('question_paper', question_id);
    fetch(url2, {
      method: 'GET',
      headers: {
        'content-Type': 'application/json',
        'Authorization': 'token' + ' ' + token,
      }
    }).then(res => {
      return res.json()
    }).then(data => {
      console.log(data)
      data.forEach((d, index) => {
        marks += d.mark
        duration += d.duration
      })
      console.log(marks, duration)
    }).then(() => {
      console.log(marks, duration)
      fetch('https://schooltestproject.herokuapp.com/api/test/',
        {
          method: 'POST',
          body: JSON.stringify({ 'grade': grade_id, 'subject': subject_id, 'question_paper': question_id, 'created_staff_id': userId, 'marks': marks, 'duration': duration, 'remarks': form_remarks, 'pass_percentage': form_percentage, 'description': form_description }
          ),
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization': 'token' + ' ' + token,
            'X-CSRFToken': csrftoken
          },
        }).then(response => {
          if (response.status == 201) {
            console.log("Sucess response", response);
            // test_messages.innerHTML = `<p class="text-success"> ${form_remarks} test created successfully</p>`;
            // test_errors.innerHTML = ''
            modal_body.innerHTML = `<p class='success' > ${form_remarks} test created successfully</p>`;
            document.getElementById('test-create-btn').style.display = 'none'
          }
          return response.json();
        }).then(function (data) {
          console.log(data)
          if (data.status != 'success') {
            test_errors.innerHTML = `<li class='test-warning'>${(data.data.error)}</li>`;
            test_messages.innerHTML = '';
          }
        })
    })

   

  }
  function getsubjectname(element){
    subject_name = element.options[element.selectedIndex].text;
    get();
  }
  function getgradename(element){
    grade_name = element.options[element.selectedIndex].text;
  }

  function edit_question_paper(id, timing, overall_marks) {
    document.querySelector('.modal-body-2').innerHTML = `<p><label for="id_timing">Timing:</label> <input type="number" name="timing"           placeholder="duration in seconds" min="0" required="" id="id_timing"></p>
          <p><label for="id_overallmarks">Overallmarks:</label> <input type="number" name="overallmarks" min="0"
              required="" id="id_overallmarks"></p>`
    document.getElementById('id_timing').value = timing
    document.getElementById('id_overallmarks').value = overall_marks
    document.querySelector('.question-edit-btn-container').innerHTML = `<button type="button" id="questionpaper-edit-btn"
              class="btn btn-primary" onclick=question_paper_update(${id})>Update</button>`
  }


  function question_paper_update(id) {
    let timing = document.getElementById('id_timing').value
    let overall_marks = document.getElementById('id_overallmarks').value
    let csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let modal2 =   document.querySelector('.modal-body-2')
    fetch(`https://schooltestproject.herokuapp.com/api/question-paper/${id}/`,
      {
        method: 'PATCH',
        body: JSON.stringify({ 'timing': timing, 'overall_marks': overall_marks }
        ),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'Authorization': 'token' + ' ' + token,
          'X-CSRFToken': csrftoken
        },
      }).then(response => {
        if (response.status == 200) {
          console.log("Sucess response", response);
         
        modal2.innerHTML = `<p class="text-success">  updated successfully</p>`;
          document.getElementById('questionpaper-edit-btn').style.display = 'none'
        }
        return response.json();
      }).then(function (data) {
        console.log(data)
        if (data.status != 'success') {
          modal2.innerHTML = `<li class='test-warning'>${(data.data.error)}</li>`;
         
        }
        get()
      }

      )
  }
}
})
</script>
{% endblock %}