<!-- var url = 'http://www.site.com/234234234';
var id = url.substring(url.lastIndexOf('/') + 1); -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXAMINATION</title>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>
    <style>
        .test-container {
            box-shadow: rgb(50 50 93 / 25%) 0px 50px 100px -20px, rgb(0 0 0 / 30%) 0px 30px 60px -30px, rgb(10 37 64 / 35%) 0px -2px 6px 0px inset;
            padding: 1% 3%;
            margin: 3% 12%;
        }
        .counter{
            font-size: 2rem;
            /* display: inline; */
            border-radius: 6%;
            padding: 1% 0% 1% 1%;
            width: 9%;
            margin: 1% 80%;
            /* width: 10%; */
            background-color: #d5d5d5;
        }
        .instructions li {
            line-height: 200%;
        }

        .instructions h3 {
            text-align: center;
            margin: 3% auto;
        }

        input.fib {
            margin-left: 0.5%;
            border: none;
            border-bottom: 1px gray dashed;
            outline: none;
        }

        input.fib:focus {
            border: none;
            outline: none;
            border-bottom: 1px gray dashed;
        }

        .question-path {
            display: grid;
            grid-template-columns: auto auto auto auto;
            text-align: center;
            width: 16%;
            margin-left: 30%;
            gap: 5%;
            height: auto;
        }

        .question-path div {
            height: 98%;
            width: 57%;
        }

        .question-direction {
            display: flex;
            flex-direction: row-reverse;
            justify-content: space-around;
        }

        .test-title {
            text-align: center;
            margin-top: 4%;
        }

        input.fib:focus {
            border: none;
            outline: none;
            border-bottom: 1px gray dashed;
        }

        .question-path {
            display: grid;
            grid-template-columns: auto auto auto auto;
            text-align: center;
            width: 16%;
            margin-left: 30%;
            gap: 5%;
            height: auto;
        }

        .question-path div {
            height: 98%;
            width: 57%;
        }

        .question-direction {
            display: flex;
            flex-direction: row-reverse;
            justify-content: space-around;
        }


        .grey {
            background-color: #CFD2CF;
            border: none;
            border-radius: 5px;
        }

        .red {
            background-color: #FF7878;
            border: none;
            border-radius: 5px;
        }

        .green {
            background-color: #5BB318;
            border: none;
            border-radius: 5px;
        }

        @media screen and (max-width:600px) {
            .instructions {
                text-align: justify;
                padding: 7% 7% 0% 2%;
            }
            .question-direction {
                display: flex;
                flex-direction: column-reverse;
                margin: 27%;
                justify-content: normal;
            }
            .question-path {
                width: 117%;
                margin-left: -4%;
                gap: 7%;
            }
            .answer-data p{
                width: 105%;
            }

        }
        @media screen and (min-width:700px) and (max-width:800px) {
            .question-path {
                display: grid;
                grid-template-columns: auto auto auto auto;
                text-align: center;
                width: 24%;
                margin-left: 0%;
                gap: 5%;
                height: auto;
            }
        }
    </style>
</head>

<body>
    <h1 class="test-title"></h1>
    <h2 class="counter"></h2>
    <div class="test-container">

        <div class="instructions">
            <h3>INSTRUCTIONS TO THE STUDENTS DURING THE EXAM</h3>
            <ol>
                <li>College uniform and ID card is a must during examination time.</li>
                <li> Arrive at the examination venue at least 15 minutes before the commencement of examination.</li>
                <li>Students are required to bring their own writing and mathematical instruments. No borrowing
                    lending or exchange of any material is allowed during the exam.</li>
                <li>Only essential writing materials are allowed on the studentâ€™s desk. All bags and books should be
                    left
                    at the front of the respective classroom.</li>
                <li>Examination will be conducted during the allocated time shown in the examination timetable.</li>
                <li> Any unauthorised materials or devices found in your possession will be confiscated and you will be
                    liable to disciplinary action.</li>
                <li>Students who are late will not be given extra time.</li>
                <li> Students are to follow all instructions given by the invigilator.</li>
                <li> Check the course title to ensure you have the correct examination question paper.</li>
                <li>Students are not allowed to write anything on the question paper except their name and roll no.</li>
                <li> Student should write their answers in black or blue ink. Make sure you bring some spare pens with
                    you.</li>
                <li> Leave the examination hall quickly and quietly after the exam. Remember to take all your belongings
                    with you.</li>
                <li> You are not allowed to leave the examination hall temporarily or otherwise for any reason what so
                    ever until the examination time is over.</li>
                <li> Raise your hand if you wish to communicate with the invigilator. You are not allowed to
                    communicate by word or mouth.</li>
                <li> All candidates must remain seated throughout this period for invigilators to properly account for
                    all
                    answer scripts to be collected.</li>
                <li> Do not continue to write after the examination has ended </li>
            </ol>
            <p class="text-end"> <button id="start-test-btn" class="btn btn-primary btn-sm">Take Test</button> </p>
        </div>
        <div class="question-container">

        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    </div>
    <div class="question-direction">
        <div class="question-path"></div>
        <div class="answer-data"></div>
    </div>
    <script>
        var host = window.location.protocol + "//" + window.location.host;
        var url = window.location.href;
        var text = url.split('/')
        var token = localStorage.getItem("token")
        var student_id = localStorage.getItem("id")
        var id = text.at(-2)
        let subject;
        let grade;
        let question_no = 0;
        let question_list = [];
        let answer_details = []
        let question_paper_id;
        let grade_name;
        let subject_name;
        let remarks;
        let total_marks;
        let duration;
        let counter_container = document.querySelector('.counter')   
        function test_details() {
            console.log(parseInt(1.0345983745))
            fetch(`https://schooltestproject.herokuapp.com/api/test/${id}/`, {
                method: 'GET',
                headers: {
                    'content-Type': 'application/json',
                    'Authorization': 'token' + ' ' + token,
                }
            }).then(res => {
                return res.json()
            }).then(data => {
                console.log(data)
                document.querySelector('.test-title').innerHTML = `${data.remarks}`
                question_paper_id = data.question_paper
                grade_name = data.grade_name;
                subject_name = data.subject_name;
                remarks = data.remarks;
                total_marks = data.marks;
                duration = data.duration;
            })
        }
        test_details();
        document.getElementById('start-test-btn').addEventListener('click', () => {
            document.querySelector('.instructions').innerHTML = ''
            fetch(`https://schooltestproject.herokuapp.com/api/question-paper/${question_paper_id}/`, {
                method: 'GET',
                headers: {
                    'content-Type': 'application/json',
                    'Authorization': 'token' + ' ' + token,
                }
            }).then(res => {
                return res.json()
            }).then(data => {
                console.log(data)

                if (data.status == 'success') {
                    grade = data.data.grade_name
                    subject = data.data.subject_name
                    for (let i = 0; i < data.data.no_of_questions.length; i++) {
                        answer_details.push(null)
                    }
                    console.log(answer_details)
                    for (let i = 0; i < data.data.no_of_questions.length; i++) {
                        question_list.push(data.data.no_of_questions[i])
                    }
                    if (data.status == 'success') {
                     //   data.data.no_of_questions.forEach((d, index) => {
                        url2 = new URL(`https://schooltestproject.herokuapp.com/api/test-questions/`);
                        url2.searchParams.append('question_paper', question_paper_id);
                            fetch(url2, {
                                method: 'GET',
                                headers: {
                                    'content-Type': 'application/json',
                                    'Authorization': 'token' + ' ' + token,
                                }
                            }).then(res => {
                                return res.json()
                            }).then(data => {
                                console.log(data)
                                data.forEach((d, index) => {
                                question_no = index
                                answer_details[question_no] = {
                                    'id': d.id,
                                    'question': d.question,
                                    'question_type': d.question_type,
                                    'correct_answer': d.answers.answer,
                                    'option_a': d.answers.option_a,
                                    'option_b': d.answers.option_b,
                                    'option_c': d.answers.option_c,
                                    'option_d': d.answers.option_d,
                                    'answer': null,
                                    'seen': false,
                                }
                                if (d.question_type != 'MCQ') {
                                    answer_details[question_no].correct_answer = answer_details[question_no][(answer_details[question_no].correct_answer)]
                                    console.log(answer_details[question_no].correct_answer, answer_details[question_no][(answer_details[question_no].correct_answer)])
                                }
                                // console.log(answer_details)
                                question_no += 1
                                let question_details = answer_details[0]
                                answer_details[0].seen = true;
                                if (question_no == 1) {
                                    let question_content;
                                    question_content = `<p> ${remarks}</p><p> ${subject_name}</p>  `
                                    if (question_details.question_type == 'MCQ') {
                                        question_content = `<div> 
                       <hr class="hr1"> <p> ${question_no}). ${d.question}</p> 
                        <ol type="a">
                            <li><input type="radio" class='option_a_${question_details.id}' id="option_a_${question_details.id}" name="answer_${question_details.id}" value='option_a'> ${question_details.option_a}</li>
                            <li><input type="radio" class='option_b_${question_details.id}' id="option_b_${question_details.id}" name="answer_${question_details.id}" value='option_b'> ${question_details.option_b}</li>
                            <li><input type="radio" class='option_c_${question_details.id}' id="option_c_${question_details.id}" name="answer_${question_details.id}" value='option_c'> ${question_details.option_c}</li>
                            <li><input type="radio" class='option_d_${question_details.id}' id="option_d_${question_details.id}" name="answer_${question_details.id}" value='option_d'> ${question_details.option_d}</li>
                        <ol>
                            </div>
                        
                        <p class='text-end'> <button class="btn btn-primary btn-sm" onclick=next(0,1)> Next </button> </p>
                        `
                                        // console.log()
                                        // console.log(document.querySelector(`input[name="answer_${data.data.id}"]`));
                                        document.querySelector('.question-container').innerHTML = question_content
                                    }
                                    else {
                                        question_content = `<div>   <p> ${question_no}). ${d.question} <input type="text" name="answer_${question_details.id}" id="" class="fib fib_${question_details.id}"> <p>
                                                <p class='text-end'> <button class="btn btn-primary btn-sm" onclick=next(0,1)> Next </button> </p>
                                                </div>`
                                    }
                                }
                            })

                    })
                }
                    first_question(0);
                    d = duration    
         
                    function counter(){
                        console.log(d)
                        let h = Math.floor(d / 3600)
                        let m = Math.floor((d - (Math.floor(d/3600)))/60)
                        let s = d - (h*3600)-(m*60)
                        h = (h.toString()).padStart(2, '0')
                        m = (m.toString()).padStart(2, '0')
                        s = (s.toString()).padStart(2, '0')
                        if(d == 0){
                            clearInterval(interval)
                            submit()
                            counter_container.innerHTML = `timeout`
                        }else{
                            d -= 1
                            counter_container.innerHTML = `${h}:${m}:${s}`
                        }
                    }

//65
                    let interval = setInterval(counter,1000)
                }
            })
        })

        // prev next

        function next(current, n) {
            let action_number = current
            let question_details = answer_details[n]
            // saving answer

            get_ans_id = answer_details[action_number].id
            var get_ans_fib = document.getElementsByName(`answer_${get_ans_id}`);
            // answer_details[n].answer = get_ans_fib.value
            var get_ans = document.getElementsByName(`answer_${get_ans_id}`);
            let fib_answer = document.querySelector(`.fib_${get_ans_id}`)
            if (fib_answer) {
                console.log(fib_answer.value)
                answer_details[action_number].answer = fib_answer.value
            }

            let question_content = '';
            for (i = 0; i < get_ans.length; i++) {
                if (get_ans[i].checked) {
                    answer_details[action_number].answer = get_ans[i].value;
                }
            }
            // display

            //fill 
            if (question_details.question_type != 'MCQ' && question_details.answer) {
                console.log(`.fib_${question_details.id}`)

            }
            let options = ['option_a', 'option_b', 'option_c', 'option_d']

            if (question_details.question_type == 'MCQ') {
                question_content += `<div><p>${n + 1}). ${question_details.question}</p> 
                        <ol type="a">`
                for (i = 0; i < options.length; i++) {
                    console.log(question_details['option_a'])
                    if (question_details.answer == options[i]) {
                        question_content += `<li><input checked type="radio" id="${options[i]}_${question_details.id}" name="answer_${question_details.id}" value='${options[i]}'> ${question_details[options[i]]}</li>`
                    } else {
                        question_content += `<li><input type="radio" id="${options[i]}_${question_details.id}" name="answer_${question_details.id}" value='${options[i]}'> ${question_details[options[i]]}</li>`
                    }
                }
                question_content += `<ol>
                    </div>
                        `
            } else {
                if (question_details.answer) {
                    question_content = `<div>   <p> ${n + 1}). ${question_details.question}<span class=''> <input type="text" name="answer_${question_details.id}" id="" class="fib fib_${question_details.id}" value='${question_details.answer}'> </span></p> </div>`
                } else {
                    question_content = `<div>   <p> ${n + 1}). ${question_details.question}<span class=''> <input type="text" name="answer_${question_details.id}" id="" class="fib fib_${question_details.id}"> </span></p> </div>`
                }
            }




            if (n == (answer_details.length) - 1) {
                question_content += ` <p class='d-flex justify-content-between mb-3'> <button  class="btn btn-primary btn-sm" onclick=next(${n},${n - 1})> Prev </button> <button  class="btn btn-success btn-sm" id='submit' onclick=submit()>submit</button> </p> `
            }
            else if (n == 0) {
                question_content += ` <p class='text-end'> <button class="btn btn-primary btn-sm" onclick=next(${n},${n + 1})> Next </button> </p> `
            } else {
                question_content += ` <p class='d-flex justify-content-between mb-3'> <button class="btn btn-primary btn-sm" onclick=next(${n},${n - 1})> Prev </button> <button class="btn btn-primary btn-sm" onclick=next(${n},${n + 1})> Next </button> </p> `
            }




            document.querySelector('.question-container').innerHTML = question_content


            var choosed_id = question_details.id

            question_details.seen = true;

            // }
            path(n);
        }


        function first_question(current) {
            let content = '';
            for (i = 0; i < answer_details.length; i++) {
                if (i == 0) {
                    content += `<div class="red" onclick=next(${current},${i})> ${i + 1} </div>`
                } else {
                    content += `<div class="grey" onclick=next(${current},${i})> ${i + 1} </div>`
                }
            }
            document.querySelector('.question-path').innerHTML = content
            document.querySelector('.answer-data').innerHTML = `<p> Unvisited questions - ${answer_details.length - 1}</p>
            <p> Answered questions - 0 </p>
            <p> Unanswered questions - 0</p> 
            `
        }
        function path(current) {
            console.log(answer_details.length)
            let content = '';
            let unvisited = 0;
            let unanswered = 0;
            let answered = 0;
            for (i = 0; i < answer_details.length; i++) {
                temp = answer_details[i]
                if (!temp.seen) {
                    content += `<div class="grey" onclick=next(${current},${i})> ${i + 1} </div>`
                    unvisited += 1
                }
                else if (!answer_details[i].answer) {
                    content += `<div class="red" onclick=next(${current},${i})> ${i + 1} </div>`
                    unanswered += 1
                } else {
                    content += `<div class="green" onclick=next(${current},${i})> ${i + 1} </div>`
                    answered += 1
                }
            }
            document.querySelector('.question-path').innerHTML = content
            document.querySelector('.answer-data').innerHTML = `<p> Unvisited  questions - ${unvisited}</p>
            <p> Answered questions - ${answered} </p>
            <p> Unanswered questions - ${unanswered - 1} </p> 
            `
        }
        function submit() {
            console.log(answer_details)
            let wrong_answer = 0;
            let correct_answer = 0;
            let unanswered = 0;
            for (i = 0; i < answer_details.length; i++) {
                if (answer_details[i].answer == answer_details[i].correct_answer) {
                    correct_answer += 1;
                } else if (answer_details[i].answer) {
                    wrong_answer += 1
                } else {
                    unanswered += 1
                }

            }
            let score =(correct_answer / (answer_details.length))*100
            console.log(score)
            score = parseInt(score)
            console.log(score)
            let result;
            if (score < 35) {
                result = 'fail'
            } else {
                result = 'pass'
            }
            console.log('c', correct_answer, 'u', unanswered, 'w', wrong_answer, score)
            fetch('https://schooltestproject.herokuapp.com/api/test-history/',
                {
                    method: 'POST',
                    body: JSON.stringify({'grade':grade,'subject':subject, 'student_id': student_id, 'test_id': id, 'question_paper': question_paper_id, 'result': result, 'score': score, 'correct_answer': correct_answer, 'wrong_answer': wrong_answer, 'unanswered_questions': unanswered }
                    ),
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'token' + ' ' + token,
                    },
                }).then(function (response) {
                    if (response.status == 201) {
                        console.log("Sucess response", response)
                        // get();
                    } else {
                        console.log(response);
                    }
                    return response.json()
                }).then(data => {
                    console.log(data)
                    document.querySelector('.question-container').innerHTML = `<p class='text-success text-center '>Test submitted successfully<button class='btn btn-primary btn-sm ' onclick=redirect()>close</button></p>`
                    document.querySelector('.question-direction').innerHTML = ''
                    
                    if (data.status != 'success') {
                        console.log(data)
                       
                    }
                })
              
        }
        function redirect(){
            window.location.href = `${host}/home`
        }

    </script>
</body>

</html>